#!/usr/bin/env ruby
require 'find'

Find.find('./lib') do |fn|
  if fn=~/\.rb$/
    print "#{fn}:\t"
    unless system "ruby -c #{fn}"
      exit 1
    end
  end
end

_,MAJOR,MINOR,BUILD = `egrep "VERSION = '[0-9]+\\.[0-9]+\\.[0-9]+'" lib/vim-markdown.rb`.split(/\D+/)
unless MAJOR and MINOR and BUILD
  puts "Could not get VERSION."
  exit 1
end

build = File.mtime(`ls -t lib/*.rb after/*/*.vim ftplugin/*.vim plugin/*.vim | head -1`.strip).strftime('%y%m%d')
unless BUILD.start_with? build
  puts "Unexpected BUILD(#{BUILD}) !start_with?(#{build})"
  exit 1
end

unless MINOR.to_i == (minor=`egrep '^\s*def\\s+self\\.' ./lib/*.rb | wc`.to_i)
  puts "Unexpected MINOR(#{MINOR}) != #{minor}"
  exit 1
end

_,M,N,B = `egrep "Version: [0-9]+\\.[0-9]+\\.[0-9]+" doc/vim-markdown.txt`.split(/\D+/)
unless MAJOR==M and MINOR==N and BUILD==B
  puts "Doc's version not the same as Lib's."
  exit 1
end

system "cat *.md doc/*.txt | aspell list | sort -u > tmp/dictionary.new"
unless system "diff tmp/dictionary.new .dictionary"
  puts "There were spelling errors."
  exit 1
end
